<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBM Breaks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --bg: #0a0a15; --card: #1a1a2e; --accent: #00eeff; --live: #ff0055; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
        
        header { text-align: center; margin-bottom: 4rem; }
        h1 { font-size: 3rem; font-weight: 900; background: linear-gradient(90deg, var(--accent), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }

        /* YOUTUBE GRID */
        .youtube-section { max-width: 1100px; margin: 0 auto 5rem; }
        .section-title { text-align: center; font-size: 1.5rem; color: #888; margin-bottom: 2rem; font-weight: 800; }
        
        .yt-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        @media(min-width: 800px) {
            .yt-grid.live-mode { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; }
            .yt-grid.live-mode .yt-card:first-child { grid-column: 1 / 2; grid-row: 1 / 3; } 
            .yt-grid.normal-mode { grid-template-columns: repeat(3, 1fr); }
        }

        .yt-card { position: relative; background: var(--card); border-radius: 20px; overflow: hidden; cursor: pointer; transition: 0.3s; aspect-ratio: 16/9; border: 2px solid rgba(255,255,255,0.1); }
        .yt-card:hover { transform: translateY(-5px); }
        .yt-thumb { width: 100%; height: 100%; object-fit: cover; }

        /* Styles for LIVE vs UPLOAD */
        .yt-card.is-live { border: 3px solid var(--live); box-shadow: 0 0 30px rgba(255, 0, 85, 0.3); }
        .yt-badge { position: absolute; top: 15px; left: 15px; padding: 5px 12px; border-radius: 50px; font-weight: 900; font-size: 0.8rem; z-index: 2; }
        .badge-live { background: var(--live); color: white; animation: pulse 1.5s infinite; }
        .badge-upload { background: rgba(0,0,0,0.7); border: 1px solid #555; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* STORE GRID */
        .store-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; max-width: 1100px; margin: 0 auto; }
        .item-card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); position: relative; transition: 0.3s; display: flex; flex-direction: column; }
        .item-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        
        .type-tag { position: absolute; top: 15px; right: 15px; padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.8rem; color: black; z-index: 2; }
        .tag-msrp { background: #00ff9d; }
        .tag-bundle { background: #ffd700; }

        .item-img { width: 100%; height: 250px; object-fit: cover; }
        .item-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .item-btn { margin-top: auto; padding: 12px; text-align: center; background: var(--accent); color: black; font-weight: 900; text-decoration: none; border-radius: 8px; display: block; }
        .sold-out { background: #333; color: #666; pointer-events: none; }
        
        /* Mobile Fixes */
        @media(max-width: 600px) {
            h1 { font-size: 2.5rem; }
            .yt-grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>

    <header>
        <img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/245.png" style="width:100px;">
        <h1>PBM BREAKS</h1>
    </header>

    <div class="youtube-section">
        <div class="section-title">CHANNEL FEED</div>
        <div id="yt-container" class="yt-grid">
            <div style="text-align:center; grid-column: 1/-1;">
                <a href="https://www.youtube.com/@PokeballerMike" target="_blank" class="item-btn" style="max-width:200px; margin:0 auto;">VISIT YOUTUBE</a>
            </div>
        </div>
    </div>

    <div class="store-grid" id="store-container">Loading...</div>

    <script>
        const API_URL = 'https://pokeballer-worker.kronborgnielsen.workers.dev/api';
        const CHANNEL_ID = "UCdFYy9uChCNAWbvVhTYwHaQ";

        async function loadVideos() {
            const container = document.getElementById('yt-container');
            const proxy = 'https://corsproxy.io/?';
            try {
                const res = await fetch(proxy + encodeURIComponent(`https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`));
                const text = await res.text();
                const doc = new DOMParser().parseFromString(text, "text/xml");
                const entries = Array.from(doc.querySelectorAll("entry")).slice(0, 3);
                
                if(entries.length === 0) throw new Error('No videos');

                let videos = [];
                for(let entry of entries) {
                    const id = entry.querySelector("videoId").textContent;
                    const title = entry.querySelector("title").textContent;
                    let isLive = false;
                    try {
                        // Check for Live Thumbnail (HQDefault_Live exists only for streams)
                        const check = await fetch(proxy + encodeURIComponent(`https://i.ytimg.com/vi/${id}/hqdefault_live.jpg`), {method:'HEAD'});
                        if(check.ok) isLive = true;
                    } catch(e){}
                    videos.push({ id, title, isLive });
                }

                videos.sort((a,b) => b.isLive - a.isLive);
                container.className = videos.some(v=>v.isLive) ? 'yt-grid live-mode' : 'yt-grid normal-mode';
                container.innerHTML = '';

                videos.forEach(v => {
                    const thumb = v.isLive ? `https://i.ytimg.com/vi/${v.id}/hqdefault_live.jpg` : `https://i.ytimg.com/vi/${v.id}/mqdefault.jpg`;
                    const badge = v.isLive ? `<div class="yt-badge badge-live">ðŸ”´ LIVE</div>` : `<div class="yt-badge badge-upload">VIDEO</div>`;
                    const cls = v.isLive ? 'is-live' : 'is-upload';
                    container.innerHTML += `<div class="yt-card ${cls}" onclick="window.open('https://youtube.com/watch?v=${v.id}')"><img src="${thumb}" class="yt-thumb">${badge}</div>`;
                });
            } catch(e) { 
                console.log("Feed Error", e);
                // Fallback if proxy fails
                container.innerHTML = '<div style="text-align:center; grid-column: 1/-1;"><a href="https://www.youtube.com/@PokeballerMike" target="_blank" class="item-btn" style="max-width:200px; margin:0 auto;">WATCH ON YOUTUBE</a></div>'; 
            }
        }

        async function loadStore() {
            const container = document.getElementById('store-container');
            try {
                const res = await fetch(`${API_URL}/items`);
                const items = await res.json();
                // Sort Newest First
                items.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
                container.innerHTML = '';
                
                items.forEach(item => {
                    const tagClass = item.type === 'bundle' ? 'tag-bundle' : 'tag-msrp';
                    const tagText = item.type === 'bundle' ? 'BUNDLE' : 'MSRP';
                    const btn = (item.stock > 0 && item.googleFormLink) ? `<a href="${item.googleFormLink}" class="item-btn">JOIN</a>` : `<div class="item-btn sold-out">SOLD OUT</div>`;
                    const img = item.image || 'https://assets.pokemon.com/assets/cms2/img/misc/trading-card-games/cards/tcg_default_card.png';
                    
                    container.innerHTML += `
                        <div class="item-card">
                            <div class="type-tag ${tagClass}">${tagText}</div>
                            <img src="${img}" class="item-img">
                            <div class="item-content">
                                <h3>${item.name}</h3>
                                <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                                    <span style="color:var(--accent); font-weight:bold; font-size:1.2rem;">$${item.price}</span>
                                    <span style="color:#888;">${item.stock} left</span>
                                </div>
                                ${btn}
                            </div>
                        </div>`;
                });
            } catch(e) { container.innerHTML = "Error loading store."; }
        }

        loadVideos(); loadStore();
    </script>
</body>
</html>
